# AGENTS.md - Usque 项目代理说明

## 1. 项目概述

这是一个用 Go 编写的网络工具，利用 Cobra 构建命令行界面。其核心功能似乎涉及通过 QUIC 和 WireGuard 等协议建立和管理网络隧道。

代码库遵循标准的 Go 项目结构，将可复用的核心逻辑放在 `internal/` 目录中，命令相关代码放在 `cmd/` 中。

## 2. 核心命令

请在与 `go.mod` 文件相同的目录（项目根目录）中运行所有命令。

### 2.1. 构建

要编译整个项目，请运行：
```bash
go build ./...
```
这会检查所有包的编译情况，但不会在根目录产生单个二进制文件。要构建主二进制文件，请使用：
```bash
go build -o usque main.go
```

### 2.2. 测试

运行所有单元测试：
```bash
go test ./...
```

要运行特定的测试函数，例如 `TestMyFunction`，请使用 `-run` 标志，它接受一个正则表达式。将路径指定到包含测试的包：
```bash
# 语法: go test -v -run ^TestName$ ./path/to/package
go test -v -run ^TestSpecificThing$ ./internal/coolfeature
```

### 2.3. 代码审查 (Linting)

本项目使用 `golangci-lint` 进行代码审查。这是 Go 社区的标准。

要审查整个代码库，请运行：
```bash
golangci-lint run
```
在提交代码之前，请解决所有审查工具报告的问题。

### 2.4. 依赖管理

模块在 `go.mod` 文件中进行管理。要添加新依赖或清理未使用的依赖，请运行：
```bash
go mod tidy
```

## 3. 代码风格和约定

所有代码贡献都必须遵循 Go 社区的既定惯例。

### 3.1. 格式化

所有代码文件都必须使用 `gofmt` 或 `goimports` 进行格式化。`goimports` 是首选，因为它还会自动对导入进行排序。

配置你的编辑器以在保存时自动运行 `goimports`。

### 3.2. 导入

导入按组进行组织：
1. 标准库包
2. 第三方包
3. 内部项目包 (例如 `github.com/Diniboy1123/usque/...`)

`goimports` 工具会自动处理这个问题。

### 3.3. 命名约定

- **包名**: 使用简短、小写的单个词。
- **变量**: 使用 `camelCase`。
- **导出的标识符** (函数、类型、全局变量): 使用 `PascalCase`。这包括需要在包外访问的所有内容。
- **未导出的标识符**: 使用 `camelCase`。这些仅在包内部私有。
- **接口**: 倾向于使用 `-er` 后缀命名，例如 `Reader`, `Writer`。

### 3.4. 错误处理

错误处理是 Go 的一个核心部分。
- **绝不忽略错误**。如果函数返回错误，请检查它。
- 错误应该作为最后一个返回值。
- 使用 `if err != nil` 范式进行处理。
- 错误信息应该是小写的，并且不以标点符号结尾。使用 `fmt.Errorf("... %w", err)` 来包装错误，以保留原始错误的上下文。

```go
file, err := os.Open("a_file.txt")
if err != nil {
    return fmt.Errorf("opening file: %w", err)
}
defer file.Close()
```

### 3.5. 类型和结构

- 保持结构体小而专注。
- 在定义 `struct` 时，按字段类型对字段进行逻辑分组，并考虑对齐以优化内存。

### 3.6. 注释

- 所有导出的函数、类型和全局变量都**必须**有文档注释。
- 注释应该解释“为什么”，而不是“做什么”。好的代码本身就应该能清楚地表明它��做什么。
- 使用 `//` 进行行内注释，使用 `/* */` 进行块注释（尽管较少使用）。

### 3.7. 并发

- 优先使用通道 (channels) 而不是共享内存来进行 goroutine 之间的通信。
- 使用 `sync` 包中的工具（如 `Mutex`、`RWMutex`、`WaitGroup`）来处理需要共享内存的更复杂情况。

---
**记住: 数据结构是关键。优先考虑清晰、健壮的数据结构，代码逻辑自然会变得简单。**
---
